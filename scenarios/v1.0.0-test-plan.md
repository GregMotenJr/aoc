# AOS v1.0.0 — Test Plan

**Scope:** Full regression across all three platforms before any prod deployment.  
**Risk areas:** Installer (3 platforms), curl|bash piping, background service, memory, security, voice, scheduler.

---

## 1. Installation

### 1.1 Linux (curl | bash)
- [ ] `curl -fsSL .../install.sh | bash` runs without error
- [ ] Prompts appear correctly in terminal (not consumed by pipe)
- [ ] `.env` file created with correct values, permissions `600`
- [ ] TypeScript compiles without errors (`dist/` populated)
- [ ] systemd service registered: `systemctl --user status aos` shows `enabled`
- [ ] Heartbeat added to crontab: `crontab -l` shows the entry with quoted path
- [ ] Running installer twice does **not** add a duplicate crontab entry
- [ ] Install in a path with spaces (e.g. `~/my projects/aos`) — service starts correctly

### 1.2 macOS (curl | bash)
- [ ] Same curl one-liner works on macOS
- [ ] `~/Library/LaunchAgents/com.aos.bot.plist` created and loaded
- [ ] `launchctl list | grep aos` shows the agent
- [ ] Heartbeat added to crontab with quoted path
- [ ] Running installer twice does **not** duplicate crontab entry
- [ ] Bot auto-starts after login (reboot test)

### 1.3 Windows (PowerShell)
- [ ] `irm .../install.ps1 | iex` runs without error (as Administrator)
- [ ] `.env` configured correctly
- [ ] TypeScript compiles
- [ ] Task Scheduler shows `AOS-Alfred` task (triggers at logon)
- [ ] Task Scheduler shows `AOS-Heartbeat` task (repeats every 10 min)
- [ ] Both tasks run as `RunLevel Limited`
- [ ] Bot auto-starts after login (reboot test)
- [ ] Running installer twice — tasks are overwritten, not duplicated

### 1.4 Skip / Partial install
- [ ] Skipping Claude CLI install — installer continues with warning, not crash
- [ ] Skipping optional API keys (Groq, ElevenLabs, Google) — `.env` written with empty values
- [ ] Keeping existing `.env` — prompts skipped, existing file untouched
- [ ] systemd unavailable (e.g. minimal container) — installer warns and falls back to `npm start`

---

## 2. Configuration

- [ ] `TELEGRAM_BOT_TOKEN` missing → bot exits with clear error on startup
- [ ] `ALLOWED_CHAT_ID` empty → bot enters first-run mode (accepts all chats for `/chatid`)
- [ ] `ALLOWED_CHAT_ID` set → bot rejects messages from unknown chat IDs
- [ ] `ALLOWED_CHAT_IDS` (comma-separated) → all listed IDs can interact
- [ ] Invalid `LOG_LEVEL` → falls back to `info` without crash

---

## 3. Core Bot

### 3.1 Commands
- [ ] `/start` → greeting message returned
- [ ] `/chatid` → returns correct Telegram chat ID
- [ ] `/newchat` → session cleared, fresh context confirmed
- [ ] `/forget` → alias for `/newchat`, same behavior
- [ ] `/memory` → lists stored memories with salience scores
- [ ] `/voice` → toggles voice reply mode on/off, confirmed with message
- [ ] `/backup` → returns SQLite `.db` file as Telegram document
- [ ] `/schedule` → lists scheduled tasks (empty list on fresh install)

### 3.2 Message handling
- [ ] Plain text message → Claude responds
- [ ] Long message (>4096 chars) → response split correctly, no truncation
- [ ] Markdown in Claude response → rendered as HTML in Telegram correctly
- [ ] Photo attachment → forwarded to Claude, response references image content
- [ ] Document attachment → forwarded to Claude, response references content
- [ ] Rapid messages (3 in 2 seconds) → all processed, no dropped messages

### 3.3 Session persistence
- [ ] Send message, restart bot, send follow-up → Claude has prior context
- [ ] `/newchat` clears context → Claude has no memory of prior turn

---

## 4. Memory System

- [ ] Phrase "I prefer X" → semantic memory created, visible in `/memory`
- [ ] "Always do X" → semantic memory created
- [ ] Memory retrieved in follow-up conversation referencing the preference
- [ ] `/memory` salience scores update (increase) after memory is accessed
- [ ] Memory pruned after salience drops below threshold (set `MEMORY_MIN_SALIENCE=0.9`, wait for decay cron)
- [ ] FTS5 search — search term in memory body returns correct match
- [ ] Episodic memory — recent conversation context injected into next turn

---

## 5. Voice

### 5.1 Speech-to-text (Groq Whisper)
- [ ] Voice note sent → transcribed and passed to Claude
- [ ] Transcription visible in response context
- [ ] Invalid/corrupt audio → error handled gracefully, no crash

### 5.2 Text-to-speech (ElevenLabs)
- [ ] `/voice on` → Claude's text response returned as voice note
- [ ] Voice note plays correctly in Telegram
- [ ] ElevenLabs API key missing → voice mode disabled gracefully, text fallback

---

## 6. Scheduler

- [ ] `/schedule` create task → task saved to DB
- [ ] Task fires at scheduled time → delivery message sent to Telegram
- [ ] Task fails 3 times → auto-disabled, user notified
- [ ] `/schedule` list → shows task with status
- [ ] `/schedule` pause/resume → status updates correctly
- [ ] `/schedule` delete → task removed from DB
- [ ] Bot restart → scheduled tasks survive (loaded from DB on startup)

---

## 7. Security

- [ ] Message from non-allowlisted chat ID → silently rejected (no response, no crash)
- [ ] Claude response containing an API key → key redacted before delivery
- [ ] Claude response containing a password pattern → redacted before delivery
- [ ] Second bot instance started → PID lock prevents startup, clear error logged
- [ ] Stale PID file (process dead) → PID lock cleared automatically on next start

---

## 8. Heartbeat & Service Recovery

### Linux / macOS
- [ ] Kill the AOS process manually → heartbeat cron detects within 10 min and restarts
- [ ] PID file exists with dead PID → heartbeat logs warning and restarts
- [ ] No PID file → heartbeat logs warning and restarts
- [ ] After restart → PID file updated with new PID

### Windows
- [ ] Kill node process → `AOS-Heartbeat` task restarts within 10 min
- [ ] Fallback direct-start → PID written to `store/aos.pid`
- [ ] After restart → bot responds normally in Telegram

---

## 9. Backup

- [ ] `/backup` → `aos.db` delivered as Telegram file attachment
- [ ] Restored DB on fresh install → sessions, memories, tasks all intact

---

## 10. Regression — npm start (no service manager)

- [ ] `npm start` → bot starts, responds to messages
- [ ] `npm run dev` → pretty logs in terminal, bot functional
- [ ] `npm run status` → health check shows all green
- [ ] `npm test` → all tests pass (target: 70 tests)

---

## Pass Criteria

| Area | Required |
|------|----------|
| Installation (all 3 platforms) | 100% |
| Core bot commands | 100% |
| Security (auth + redaction + PID) | 100% |
| Memory (create + retrieve) | 100% |
| Heartbeat recovery | 100% |
| Voice (if keys present) | 100% |
| Scheduler | 100% |
| Edge cases / error handling | No crashes — graceful degradation only |

**A single crash or data loss = block. Graceful degradation = pass with note.**
