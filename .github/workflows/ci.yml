name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [dev]

jobs:
  # ─── Stage 0: PR Title / Commit Lint ──────────────
  commitlint:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate PR title (Conventional Commits)
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          printf 'PR title: %s\n' "$PR_TITLE"
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{1,100}$"
          if ! printf '%s' "$PR_TITLE" | grep -qE "$PATTERN"; then
            echo ""
            echo "ERROR: PR title must follow Conventional Commits format."
            echo "  Examples:"
            echo "    feat: add voice reply toggle"
            echo "    fix: resolve cron-parser ESM import"
            echo "    docs: update README install section"
            echo "    ci: add integration test stage"
            echo ""
            echo "  Type prefix determines version bump:"
            echo "    feat        → minor (1.x.0)"
            echo "    fix/perf    → patch (1.0.x)"
            echo "    feat! / BREAKING CHANGE → major (x.0.0)"
            exit 1
          fi
          echo "PASS: PR title follows Conventional Commits"

  # ─── Stage 1: Build ───────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: Typecheck
        run: npx tsc --noEmit
      - name: Compile
        run: npm run build
      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ─── Stage 2: Unit Tests ──────────────────────────
  unit-test:
    name: Unit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: Run unit tests
        run: npm test -- --reporter=verbose

  # ─── Stage 3: Integration Tests ───────────────────
  integration:
    name: Integration Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Shellcheck — install.sh
        run: |
          sudo apt-get install -y shellcheck
          shellcheck install.sh scripts/heartbeat.sh scripts/notify.sh

      - name: Config validation — missing token exits cleanly
        run: |
          cat > .env << 'EOF'
          TELEGRAM_BOT_TOKEN=
          ALLOWED_CHAT_ID=
          NODE_ENV=production
          EOF
          OUTPUT=$(node dist/index.js 2>&1 || true)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "TELEGRAM_BOT_TOKEN not set" || (echo "FAIL: Expected missing token error" && exit 1)
          echo "PASS: Missing token exits with clear error"

      - name: PID lock — stale PID is auto-cleared
        run: |
          mkdir -p store
          echo "99999" > store/aos.pid
          cat > .env << 'EOF'
          TELEGRAM_BOT_TOKEN=test_fake_token
          ALLOWED_CHAT_ID=
          NODE_ENV=production
          LOG_LEVEL=debug
          EOF
          OUTPUT=$(timeout 3 node dist/index.js 2>&1 || true)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "Removing stale PID" || (echo "FAIL: Stale PID not cleared" && exit 1)
          echo "PASS: Stale PID cleared on startup"

      - name: Heartbeat — no PID file triggers fallback restart
        run: |
          rm -f store/aos.pid store/heartbeat.log
          bash scripts/heartbeat.sh 2>&1 || true
          sleep 1
          cat store/heartbeat.log
          grep -q "WARN: No PID file found" store/heartbeat.log   || (echo "FAIL: Expected no-PID-file warning" && exit 1)
          grep -q "AOS started directly"    store/heartbeat.log   || (echo "FAIL: Fallback start not logged"     && exit 1)
          [ -f store/aos.pid ] || (echo "FAIL: PID not written to file after fallback start" && exit 1)
          echo "PASS: Heartbeat fallback start writes PID"
          kill $(cat store/aos.pid) 2>/dev/null || true

      - name: Heartbeat — stale PID triggers restart
        run: |
          mkdir -p store && echo "99999" > store/aos.pid
          rm -f store/heartbeat.log
          bash scripts/heartbeat.sh 2>&1 || true
          sleep 1
          cat store/heartbeat.log
          grep -q "Stale PID" store/heartbeat.log || (echo "FAIL: Expected stale PID warning" && exit 1)
          echo "PASS: Heartbeat handles stale PID"
          kill $(cat store/aos.pid) 2>/dev/null || true

      - name: Heartbeat — running process is left alone
        run: |
          mkdir -p store
          sleep 60 &
          echo "$!" > store/aos.pid
          bash scripts/heartbeat.sh
          echo "PASS: Heartbeat exits 0 when process is alive"
          kill $(cat store/aos.pid) 2>/dev/null || true

      - name: npm run status — executes without crash
        continue-on-error: true  # exits non-zero in CI (bot not running) — that's expected
        run: npm run status

  # ─── Stage 4: E2E Tests (requires secret) ─────────
  e2e:
    name: E2E Tests
    needs: [unit-test, integration]
    runs-on: ubuntu-latest
    steps:
      - name: Check secrets available
        id: check
        env:
          TOKEN: ${{ secrets.TELEGRAM_TEST_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "⚠️  TELEGRAM secrets not set — skipping E2E"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "✓ TELEGRAM secrets present — running E2E"
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.skip == 'false'

      - uses: actions/setup-node@v4
        if: steps.check.outputs.skip == 'false'
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        if: steps.check.outputs.skip == 'false'
        run: npm ci

      - name: Download dist
        if: steps.check.outputs.skip == 'false'
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Install Claude CLI mock
        if: steps.check.outputs.skip == 'false'
        run: |
          mkdir -p /usr/local/bin
          printf '#!/bin/bash\necho '"'"'{"role":"assistant","content":"CI test response"}'"'"'\n' \
            > /usr/local/bin/claude
          chmod +x /usr/local/bin/claude

      - name: Configure .env
        if: steps.check.outputs.skip == 'false'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TEST_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
        run: |
          printf 'TELEGRAM_BOT_TOKEN=%s\nALLOWED_CHAT_ID=%s\nNODE_ENV=production\nLOG_LEVEL=info\n' \
            "$TOKEN" "$CHAT_ID" > .env
          chmod 600 .env

      - name: Start bot
        if: steps.check.outputs.skip == 'false'
        run: |
          mkdir -p store
          node dist/index.js &
          echo "$!" > store/aos.pid
          sleep 3
          echo "Bot PID: $(cat store/aos.pid)"

      - name: E2E — /start command
        if: steps.check.outputs.skip == 'false'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TEST_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
        run: |
          node -e "
            const r = await fetch('https://api.telegram.org/bot' + process.env.TOKEN + '/sendMessage', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ chat_id: process.env.CHAT_ID, text: '/start' })
            });
            const j = await r.json();
            console.log('Sent /start:', j.ok);
            if (!j.ok) process.exit(1);
          "
          sleep 5

      - name: E2E — /chatid command
        if: steps.check.outputs.skip == 'false'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TEST_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_TEST_CHAT_ID }}
        run: |
          node -e "
            const r = await fetch('https://api.telegram.org/bot' + process.env.TOKEN + '/sendMessage', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ chat_id: process.env.CHAT_ID, text: '/chatid' })
            });
            const j = await r.json();
            console.log('Sent /chatid:', j.ok);
            if (!j.ok) process.exit(1);
          "
          sleep 5

      - name: E2E — unauthorized chat rejected
        if: steps.check.outputs.skip == 'false'
        env:
          TOKEN: ${{ secrets.TELEGRAM_TEST_TOKEN }}
        run: |
          node -e "
            const r = await fetch('https://api.telegram.org/bot' + process.env.TOKEN + '/sendMessage', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ chat_id: '-9999999999', text: 'unauthorized test' })
            });
            const j = await r.json();
            console.log('Unauthorized send attempted (expect ok:false or error):', j.ok);
          "
          sleep 3

      - name: Collect bot logs
        if: always()
        run: cat store/aos.log 2>/dev/null || echo "No log file"

      - name: Stop bot
        if: always()
        run: kill $(cat store/aos.pid 2>/dev/null) 2>/dev/null || true
